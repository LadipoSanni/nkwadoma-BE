name: Java CI with Maven

on:
  push:
    branches:
      - systest

env:
  PROFILE: systest
  AWS_REGION: eu-west-1
  API_VERSIONING: /api/v1
  DEV_FRONTEND_BASE_URL: http://localhost:3000
  KEYCLOAK_IMAGE: quay.io/keycloak/keycloak:26.2.5
  KEYCLOAK_CONTAINER: keycloak
  KEYCLOAK_PORT: 8080
  KEYCLOAK_REALM: meedl-prod
  KEYCLOAK_ADMIN: admin
  KEYCLOAK_ADMIN_PASSWORD: admin
  CLIENT_ID: meedl

jobs:
  test:
    name: üß™ Unit & Integration Tests
    runs-on: ubuntu-24.04

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: meedl_build
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
          --mount type=tmpfs,destination=/var/lib/postgresql/data
        ports:
          - 5432:5432

    outputs:
      keycloak_client_secret: ${{ steps.keycloak.outputs.client_secret }}
      keycloak_client_id: ${{ steps.keycloak.outputs.client_id }}
      keycloak_realm: ${{ steps.keycloak.outputs.realm }}
      keycloak_server: ${{ steps.keycloak.outputs.server }}

    steps:
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      - name: üß∞ Install PostgreSQL client + jq
        run: sudo apt-get update && sudo apt-get install -y postgresql-client curl jq

      - name: üïí Wait for PostgreSQL
        run: |
          echo "‚è≥ Waiting for PostgreSQL to start..."
          for i in {1..30}; do
            if pg_isready -h localhost -U postgres > /dev/null 2>&1; then
              echo "‚úÖ PostgreSQL is ready!"
              break
            fi
            sleep 2
          done

      - name: üöÄ Start Keycloak (Realm Import)
        run: |
          echo "Starting Keycloak (Realm: $KEYCLOAK_REALM)..."
          docker run -d --name $KEYCLOAK_CONTAINER \
            -p $KEYCLOAK_PORT:8080 \
            -e KEYCLOAK_ADMIN=$KEYCLOAK_ADMIN \
            -e KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD \
            -v $PWD/backend/keycloak/realms/$KEYCLOAK_REALM.json:/opt/keycloak/data/import/$KEYCLOAK_REALM.json \
            $KEYCLOAK_IMAGE \
            start-dev --import-realm \
              --http-enabled=true \
              --hostname-strict=false \
              --spi-theme-static-max-age=-1 \
              --spi-theme-cache-themes=false \
              --spi-theme-cache-templates=false \
              --features=scripts,token-exchange,admin-fine-grained-authz

          echo "‚è≥ Waiting for Keycloak..."
          for i in {1..60}; do
            if curl -fs "http://localhost:$KEYCLOAK_PORT/realms/$KEYCLOAK_REALM" > /dev/null; then
              echo "‚úÖ Keycloak is up and realm is available!"
              break
            fi
            echo "Still waiting... ($i/60)"
            sleep 5
          done

      - name: üîê Extract and Sync Keycloak Client Secret
        id: keycloak
        run: |
          echo "üîë Logging into Keycloak (master realm)..."
          docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh config credentials \
            --server http://localhost:${KEYCLOAK_PORT} \
            --realm master \
            --user "$KEYCLOAK_ADMIN" \
            --password "$KEYCLOAK_ADMIN_PASSWORD"

          echo "üîç Fetching client UUID for realm $KEYCLOAK_REALM..."
          CLIENT_UUID=$(docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh get clients -r $KEYCLOAK_REALM --fields id,clientId | jq -r ".[] | select(.clientId==\"$CLIENT_ID\") | .id")

          if [ -z "$CLIENT_UUID" ]; then
            echo "‚ö†Ô∏è Client $CLIENT_ID not found, creating..."
            docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh create clients -r $KEYCLOAK_REALM \
              -s clientId=$CLIENT_ID -s enabled=true -s publicClient=false -s 'redirectUris=["*"]'
            CLIENT_UUID=$(docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh get clients -r $KEYCLOAK_REALM --fields id,clientId | jq -r ".[] | select(.clientId==\"$CLIENT_ID\") | .id")
          fi

          CLIENT_SECRET=$(docker exec $KEYCLOAK_CONTAINER /opt/keycloak/bin/kcadm.sh get clients/$CLIENT_UUID/client-secret -r $KEYCLOAK_REALM | jq -r '.value')

          echo "‚úÖ Keycloak Client Secret fetched successfully."
          echo "client_secret=$CLIENT_SECRET" >> $GITHUB_OUTPUT
          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT
          echo "realm=$KEYCLOAK_REALM" >> $GITHUB_OUTPUT
          echo "server=http://localhost:${KEYCLOAK_PORT}" >> $GITHUB_OUTPUT

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: üß™ Run Maven Tests
        env:
          DATABASE_HOST: localhost
          DATABASE_PORT: 5432
          DATABASE_NAME: meedl_build
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
          DATABASE_URL: jdbc:postgresql://localhost:5432/meedl_build
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/meedl_build
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: postgres
          KEYCLOAK_SERVER: http://localhost:8080
          KEYCLOAK_CLIENT_ID: ${{ steps.keycloak.outputs.client_id }}
          KEYCLOAK_CLIENT_SECRET: ${{ steps.keycloak.outputs.client_secret }}
          KEYCLOAK_REALM: ${{ steps.keycloak.outputs.realm }}
          KEYCLOAK_USERNAME: ${{ env.KEYCLOAK_ADMIN }}
          KEYCLOAK_PASSWORD: ${{ env.KEYCLOAK_ADMIN_PASSWORD }}
          FRONTEND_BASE_URL: ${{ env.DEV_FRONTEND_BASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION: ${{ secrets.JWT_EXPIRATION }}
          SUPER_ADMIN_FIRST_NAME: ${{ secrets.SUPER_ADMIN_FIRST_NAME }}
          SUPER_ADMIN_LAST_NAME: ${{ secrets.SUPER_ADMIN_LAST_NAME }}
          SUPER_ADMIN_EMAIL: ${{ secrets.SUPER_ADMIN_EMAIL }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_SENDER: ${{ secrets.MAIL_SENDER }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          AWS_REGION: ${{ env.AWS_REGION }}
          IV_AES_KEY: ${{ secrets.IV_AES_KEY }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "‚úÖ Database initialized at: $DATABASE_URL"
          echo "üöÄ Running Maven tests..."
          mvn -B clean test

      - name: üìä Upload Surefire Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports
          path: target/surefire-reports/

      - name: üßπ Clean up Keycloak container
        if: always()
        run: |
          echo "üßπ Cleaning up Keycloak..."
          docker stop $KEYCLOAK_CONTAINER || true
          docker rm $KEYCLOAK_CONTAINER || true


  build:
    name: üèóÔ∏è Build & Analyze
    needs: [test]
    runs-on: ubuntu-latest

    env:
      KEYCLOAK_CLIENT_SECRET: ${{ needs.test.outputs.keycloak_client_secret }}
      KEYCLOAK_CLIENT_ID: ${{ needs.test.outputs.keycloak_client_id }}
      KEYCLOAK_REALM: ${{ needs.test.outputs.keycloak_realm }}
      KEYCLOAK_SERVER: ${{ needs.test.outputs.keycloak_server }}
      AWS_REGION: eu-west-1

    steps:
      - uses: actions/checkout@v4

      - name: ‚òï Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: üßæ Confirm Keycloak values from previous job
        run: |
          echo "Client ID: $KEYCLOAK_CLIENT_ID"
          echo "Client Secret: $KEYCLOAK_CLIENT_SECRET"
          echo "Realm: $KEYCLOAK_REALM"
          echo "Server: $KEYCLOAK_SERVER"

      - name: üèóÔ∏è Build JAR
        run: mvn -B clean package -DskipTests
